<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="description" content="Love Graph - æ¢ç´¢äººé™…å…³ç³»ç½‘ç»œçš„å¯è§†åŒ–å·¥å…·ï¼Œå‘ç°è¿æ¥ã€å¯»æ‰¾è·¯å¾„ã€æœç´¢èŠ‚ç‚¹" />
  <meta name="keywords" content="å…³ç³»å›¾è°±, ç¤¾äº¤ç½‘ç»œ, å¯è§†åŒ–, äººé™…å…³ç³»" />
  <meta name="author" content="Love Graph Team" />
  <meta name="theme-color" content="#6366f1" media="(prefers-color-scheme: light)" />
  <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)" />
  
  <!-- PWA Meta Tags -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Love Graph" />
  <meta name="application-name" content="Love Graph" />
  <meta name="msapplication-TileColor" content="#6366f1" />
  <meta name="msapplication-config" content="browserconfig.xml" />
  
  <title>Love Graph - æ¢ç´¢å…³ç³»è¿æ¥</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’•</text></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  
  <!-- Apple Touch Icons -->
  <link rel="apple-touch-icon" href="icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png" />
  
  <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- å­—ä½“ -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- å›¾æ ‡åº“ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  
  <!-- æ ·å¼æ–‡ä»¶ -->
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="animation_styles.css">
  
  <!-- Cytoscape æ ¸å¿ƒåº“ -->
  <script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
  
  <!-- Cytoscape å¸ƒå±€æ’ä»¶ -->
  <script src="https://unpkg.com/layout-base@2.0.1/layout-base.js"></script>
  <script src="https://unpkg.com/cose-base@2.2.0/cose-base.js"></script>
  <script src="https://unpkg.com/cytoscape-cose-bilkent@4.1.0/cytoscape-cose-bilkent.js"></script>
  
  <!-- Fuse.js æ¨¡ç³Šæœç´¢ -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J6V8G528D2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J6V8G528D2');
  </script>
</head>

<body>
  <!-- åŠ è½½åŠ¨ç”» -->
  <div id="loader" class="loader">
    <div class="loader-content">
      <div class="loader-spinner"></div>
      <p class="loader-text">æ­£åœ¨åŠ è½½å…³ç³»å›¾è°±...</p>
    </div>
  </div>

  <!-- ä¸»å®¹å™¨ -->
  <div class="app-container">
    <!-- å¤´éƒ¨å¯¼èˆª -->
    <header class="header">
      <div class="header-content">
        <div class="logo">
          <span class="logo-icon">ğŸ’•</span>
          <h1 class="logo-text">Love Graph</h1>
        </div>
        
        <nav class="nav-actions">
          <button id="themeToggle" class="btn btn-icon" title="åˆ‡æ¢ä¸»é¢˜">
            <i class="fas fa-moon"></i>
          </button>
          <a href="Changelog.html" class="btn btn-outline">
            <i class="fas fa-history"></i>
            <span>æ›´æ–°æ—¥å¿—</span>
          </a>
        </nav>
      </div>
    </header>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
      <!-- ä¾§è¾¹æ  -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <h2>æ§åˆ¶é¢æ¿</h2>
          <button id="closeSidebar" class="btn btn-icon btn-sm">
            <i class="fas fa-times"></i>
          </button>
        </div>

        <!-- ä¾§è¾¹æ å†…å®¹åŒº - ç‹¬ç«‹æ»šåŠ¨ -->
        <div class="sidebar-content">
          <!-- å›¾ä¾‹ -->
          <section class="panel">
            <h3 class="panel-title">
              <i class="fas fa-palette"></i>
              å›¾ä¾‹è¯´æ˜
            </h3>
            <div class="legend">
              <div class="legend-section">
                <h4>èŠ‚ç‚¹ç±»å‹</h4>
                <div class="legend-item">
                  <span class="legend-dot male"></span>
                  <span>ç”·æ€§</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot female"></span>
                  <span>å¥³æ€§</span>
                </div>
              </div>
              <div class="legend-section">
                <h4>å…³ç³»ç±»å‹</h4>
                <div class="legend-item">
                  <span class="legend-line current"></span>
                  <span>ç°ä»»ä¼´ä¾£</span>
                </div>
                <div class="legend-item">
                  <span class="legend-line ex"></span>
                  <span>å‰ä»»ä¼´ä¾£</span>
                </div>
                <div class="legend-item">
                  <span class="legend-line affection"></span>
                  <span>å•å‘å¥½æ„Ÿ</span>
                </div>
              </div>
            </div>
          </section>

          <!-- æœç´¢é¢æ¿ -->
          <section class="panel">
            <h3 class="panel-title">
              <i class="fas fa-search"></i>
              æœç´¢èŠ‚ç‚¹
            </h3>
            <div class="search-box">
              <input type="text" id="searchInput" class="input" placeholder="è¾“å…¥åå­—æœç´¢...">
              <i class="fas fa-search search-icon"></i>
            </div>
            <div id="searchResults" class="search-results"></div>
          </section>

          <!-- è·¯å¾„æŸ¥æ‰¾ -->
          <section class="panel">
            <h3 class="panel-title">
              <i class="fas fa-route"></i>
              è·¯å¾„æŸ¥æ‰¾
            </h3>
            <div class="form-group">
              <input type="text" id="pathStart" class="input" placeholder="èµ·å§‹èŠ‚ç‚¹">
            </div>
            <div class="form-group">
              <input type="text" id="pathEnd" class="input" placeholder="ç›®æ ‡èŠ‚ç‚¹">
            </div>
            <button id="findPath" class="btn btn-primary btn-block">
              <i class="fas fa-project-diagram"></i>
              æŸ¥æ‰¾æœ€çŸ­è·¯å¾„
            </button>
          </section>

          <!-- ç­›é€‰å™¨ -->
          <section class="panel">
            <h3 class="panel-title">
              <i class="fas fa-filter"></i>
              å…³ç³»ç­›é€‰
            </h3>
            <div class="form-group">
              <select id="relationFilter" class="select">
                <option value="">æ˜¾ç¤ºæ‰€æœ‰å…³ç³»</option>
                <option value="CURRENT_PARTNER">ä»…æ˜¾ç¤ºç°ä»»</option>
                <option value="EX_PARTNER">ä»…æ˜¾ç¤ºå‰ä»»</option>
                <option value="AFFECTION">ä»…æ˜¾ç¤ºå¥½æ„Ÿ</option>
              </select>
            </div>
            <div class="form-group">
              <select id="genderFilter" class="select">
                <option value="">æ˜¾ç¤ºæ‰€æœ‰æ€§åˆ«</option>
                <option value="ç”·">ä»…æ˜¾ç¤ºç”·æ€§</option>
                <option value="å¥³">ä»…æ˜¾ç¤ºå¥³æ€§</option>
              </select>
            </div>
            <div class="form-group">
              <label class="filter-label">æŒ‰è¿æ¥æ•°ç­›é€‰</label>
              <div class="range-container">
                <input type="range" id="connectionFilter" class="range-input" min="0" max="20" value="0">
                <span id="connectionValue" class="range-value">â‰¥ 0</span>
              </div>
            </div>
            <button id="resetView" class="btn btn-secondary btn-block">
              <i class="fas fa-undo"></i>
              é‡ç½®è§†å›¾
            </button>
          </section>

          <!-- å¸ƒå±€é€‰æ‹© -->
          <section class="panel">
            <h3 class="panel-title">
              <i class="fas fa-sitemap"></i>
              å¸ƒå±€æ–¹å¼
            </h3>
            <div class="layout-options">
              <button class="layout-btn active" data-layout="cose-bilkent">
                <i class="fas fa-project-diagram"></i>
                <span>åŠ›å¯¼å‘</span>
              </button>
              <button class="layout-btn" data-layout="circle">
                <i class="fas fa-circle-notch"></i>
                <span>åœ†å½¢</span>
              </button>
              <button class="layout-btn" data-layout="grid">
                <i class="fas fa-th"></i>
                <span>ç½‘æ ¼</span>
              </button>
              <button class="layout-btn" data-layout="concentric">
                <i class="fas fa-bullseye"></i>
                <span>åŒå¿ƒåœ†</span>
              </button>
            </div>
          </section>

          <!-- å¯¼å‡ºåŠŸèƒ½ -->
          <section class="panel">
            <h3 class="panel-title">
              <i class="fas fa-download"></i>
              å¯¼å‡ºå›¾ç‰‡
            </h3>
            <div class="export-buttons">
              <button id="exportPng" class="btn btn-outline btn-sm">
                <i class="fas fa-image"></i>
                PNG
              </button>
              <button id="exportJpg" class="btn btn-outline btn-sm">
                <i class="fas fa-file-image"></i>
                JPG
              </button>
              <button id="exportJson" class="btn btn-outline btn-sm">
                <i class="fas fa-code"></i>
                JSON
              </button>
            </div>
          </section>
        </div>
      </aside>

      <!-- ä¾§è¾¹æ é®ç½©ï¼ˆç§»åŠ¨ç«¯ï¼‰ -->
      <div id="sidebarOverlay" class="sidebar-overlay hidden"></div>

      <!-- å›¾è°±åŒºåŸŸ -->
      <div class="graph-container">
        <!-- å·¥å…·æ  -->
        <div class="toolbar">
          <button id="toggleSidebar" class="btn btn-icon" title="æ‰“å¼€æ§åˆ¶é¢æ¿">
            <i class="fas fa-bars"></i>
          </button>
          <div class="toolbar-divider"></div>
          <button id="zoomIn" class="btn btn-icon" title="æ”¾å¤§">
            <i class="fas fa-plus"></i>
          </button>
          <button id="zoomOut" class="btn btn-icon" title="ç¼©å°">
            <i class="fas fa-minus"></i>
          </button>
          <button id="fitView" class="btn btn-icon" title="é€‚åº”è§†å›¾">
            <i class="fas fa-expand"></i>
          </button>
          <div class="toolbar-divider"></div>
          <button id="showDashboard" class="btn btn-icon" title="æ•°æ®ä»ªè¡¨ç›˜">
            <i class="fas fa-chart-pie"></i>
          </button>
          <button id="showRanking" class="btn btn-icon" title="æ’è¡Œæ¦œ">
            <i class="fas fa-trophy"></i>
          </button>
          <div class="toolbar-divider"></div>
          <button id="showComments" class="btn btn-icon" title="è¯„è®ºåŒº">
            <i class="fas fa-comments"></i>
          </button>
          <div class="share-button-wrapper">
            <button id="showShare" class="btn btn-icon" title="åˆ†äº«">
              <i class="fas fa-share-alt"></i>
            </button>
            <!-- åˆ†äº«å¼¹çª— -->
            <div id="sharePopup" class="share-popup hidden">
              <div class="share-popup-header">åˆ†äº«åˆ°</div>
              <div class="share-popup-content">
                <button class="share-option" data-platform="weibo" title="å¾®åš">
                  <i class="fab fa-weibo"></i>
                  <span>å¾®åš</span>
                </button>
                <button class="share-option" data-platform="twitter" title="Twitter">
                  <i class="fab fa-twitter"></i>
                  <span>Twitter</span>
                </button>
                <button class="share-option" data-platform="wechat" title="å¾®ä¿¡">
                  <i class="fab fa-weixin"></i>
                  <span>å¾®ä¿¡</span>
                </button>
                <button class="share-option" data-platform="qq" title="QQ">
                  <i class="fab fa-qq"></i>
                  <span>QQ</span>
                </button>
                <button class="share-option" data-platform="copy" title="å¤åˆ¶é“¾æ¥">
                  <i class="fas fa-link"></i>
                  <span>å¤åˆ¶é“¾æ¥</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Cytoscape ç”»å¸ƒ -->
        <div id="cy" class="graph-canvas"></div>

        <!-- èŠ‚ç‚¹ä¿¡æ¯å¡ï¼ˆå¢å¼ºç‰ˆï¼‰ -->
        <div id="nodeInfo" class="node-info-card hidden">
          <button id="closeNodeInfo" class="close-btn">
            <i class="fas fa-times"></i>
          </button>
          <div id="nodeInfoContent"></div>
          <div class="node-info-tabs">
            <button class="node-tab active" data-tab="relations">å…³ç³»åˆ—è¡¨</button>
            <button class="node-tab" data-tab="network">å…³ç³»ç½‘ç»œ</button>
          </div>
          <div id="nodeRelationsList" class="node-relations-list"></div>
          <div class="node-info-actions">
            <button id="focusNeighbors" class="btn btn-sm btn-outline">
              <i class="fas fa-eye"></i> æŸ¥çœ‹å…³ç³»ç½‘
            </button>
            <button id="findCommon" class="btn btn-sm btn-outline">
              <i class="fas fa-users"></i> æ‰¾å…±åŒå¥½å‹
            </button>
          </div>
        </div>

        <!-- ç»Ÿè®¡é¢æ¿ -->
        <div class="stats-panel">
          <div class="stat-item">
            <span class="stat-value" id="totalNodes">0</span>
            <span class="stat-label">èŠ‚ç‚¹</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="totalEdges">0</span>
            <span class="stat-label">å…³ç³»</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="maleCount">0</span>
            <span class="stat-label">ç”·æ€§</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="femaleCount">0</span>
            <span class="stat-label">å¥³æ€§</span>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- é€šçŸ¥ç»„ä»¶ -->
  <div id="toast" class="toast">
    <div class="toast-icon">
      <i class="fas fa-info-circle"></i>
    </div>
    <div class="toast-content">
      <p id="toastMessage"></p>
    </div>
  </div>

  <!-- æ¨¡æ€æ¡† -->
  <div id="modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-container">
      <div class="modal-header">
        <h3 id="modalTitle">æ ‡é¢˜</h3>
        <button id="closeModal" class="close-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="modalBody" class="modal-body"></div>
      <div id="modalFooter" class="modal-footer"></div>
    </div>
  </div>

  <!-- æ•°æ®ä»ªè¡¨ç›˜ -->
  <div id="dashboardPanel" class="dashboard-panel hidden">
    <div class="dashboard-header">
      <h3><i class="fas fa-chart-pie"></i> æ•°æ®ä»ªè¡¨ç›˜</h3>
      <button id="closeDashboard" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="dashboard-content">
      <!-- æ¦‚è§ˆå¡ç‰‡ -->
      <div class="dashboard-overview">
        <div class="overview-card">
          <div class="overview-icon" style="background: linear-gradient(135deg, #6366f1, #818cf8);">
            <i class="fas fa-users"></i>
          </div>
          <div class="overview-info">
            <span class="overview-value" id="dashTotalNodes">0</span>
            <span class="overview-label">æ€»äººæ•°</span>
          </div>
        </div>
        <div class="overview-card">
          <div class="overview-icon" style="background: linear-gradient(135deg, #ec4899, #f472b6);">
            <i class="fas fa-heart"></i>
          </div>
          <div class="overview-info">
            <span class="overview-value" id="dashTotalEdges">0</span>
            <span class="overview-label">æ€»å…³ç³»</span>
          </div>
        </div>
        <div class="overview-card">
          <div class="overview-icon" style="background: linear-gradient(135deg, #22c55e, #4ade80);">
            <i class="fas fa-link"></i>
          </div>
          <div class="overview-info">
            <span class="overview-value" id="dashAvgConnections">0</span>
            <span class="overview-label">å¹³å‡è¿æ¥</span>
          </div>
        </div>
        <div class="overview-card">
          <div class="overview-icon" style="background: linear-gradient(135deg, #f59e0b, #fbbf24);">
            <i class="fas fa-crown"></i>
          </div>
          <div class="overview-info">
            <span class="overview-value" id="dashMaxConnections">0</span>
            <span class="overview-label">æœ€å¤§è¿æ¥</span>
          </div>
        </div>
      </div>

      <!-- å›¾è¡¨åŒºåŸŸ -->
      <div class="dashboard-charts">
        <!-- æ€§åˆ«åˆ†å¸ƒ -->
        <div class="chart-card">
          <h4>æ€§åˆ«åˆ†å¸ƒ</h4>
          <div class="chart-container">
            <div id="genderChart" class="donut-chart"></div>
            <div class="chart-legend" id="genderLegend"></div>
          </div>
        </div>
        
        <!-- å…³ç³»ç±»å‹åˆ†å¸ƒ -->
        <div class="chart-card">
          <h4>å…³ç³»ç±»å‹åˆ†å¸ƒ</h4>
          <div class="chart-container">
            <div id="relationChart" class="donut-chart"></div>
            <div class="chart-legend" id="relationLegend"></div>
          </div>
        </div>
      </div>

      <!-- è¿æ¥åº¦åˆ†å¸ƒ -->
      <div class="chart-card full-width">
        <h4>è¿æ¥åº¦åˆ†å¸ƒ</h4>
        <div id="connectionDistChart" class="bar-chart"></div>
      </div>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œé¢æ¿ -->
  <div id="rankingPanel" class="ranking-panel hidden">
    <div class="ranking-header">
      <h3><i class="fas fa-trophy"></i> æ’è¡Œæ¦œ</h3>
      <button id="closeRanking" class="close-btn">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="ranking-tabs">
      <button class="ranking-tab active" data-tab="connections">è¿æ¥æ•°æœ€å¤š</button>
      <button class="ranking-tab" data-tab="admirers">è¢«å¥½æ„Ÿæœ€å¤š</button>
      <button class="ranking-tab" data-tab="exes">å‰ä»»æœ€å¤š</button>
    </div>
    <div class="ranking-content" id="rankingContent">
      <!-- åŠ¨æ€å¡«å…… -->
    </div>
  </div>

  <!-- è¯„è®ºåŒºæ¨¡æ€æ¡† -->
  <div id="commentsModal" class="comments-modal hidden">
    <div class="comments-modal-backdrop"></div>
    <div class="comments-modal-content">
      <div class="comments-modal-header">
        <h3><i class="fas fa-comments"></i> è¯„è®ºåŒº</h3>
        <button id="closeComments" class="close-btn">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="comments-modal-body">
        <script src="https://utteranc.es/client.js"
          repo="Last-emo-boy/RelationWeb"
          issue-term="pathname"
          theme="preferred-color-scheme"
          crossorigin="anonymous"
          async>
        </script>
      </div>
    </div>
  </div>

  <!-- PWA å®‰è£…æç¤º -->
  <div id="pwaInstallPrompt" class="pwa-install-prompt hidden">
    <div class="pwa-install-content">
      <div class="pwa-install-icon">ğŸ’•</div>
      <div class="pwa-install-text">
        <strong>å®‰è£… Love Graph</strong>
        <span>æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œéšæ—¶è®¿é—®</span>
      </div>
      <div class="pwa-install-actions">
        <button id="pwaInstallBtn" class="btn btn-primary btn-sm">
          <i class="fas fa-download"></i> å®‰è£…
        </button>
        <button id="pwaInstallDismiss" class="btn btn-ghost btn-sm">
          ç¨å
        </button>
      </div>
    </div>
  </div>

  <!-- PWA æ›´æ–°æç¤º -->
  <div id="pwaUpdatePrompt" class="pwa-update-prompt hidden">
    <div class="pwa-update-content">
      <i class="fas fa-sync-alt"></i>
      <span>æœ‰æ–°ç‰ˆæœ¬å¯ç”¨</span>
      <button id="pwaUpdateBtn" class="btn btn-primary btn-sm">ç«‹å³æ›´æ–°</button>
      <button id="pwaUpdateDismiss" class="btn btn-ghost btn-sm">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- ç¦»çº¿æç¤º -->
  <div id="offlineIndicator" class="offline-indicator hidden">
    <i class="fas fa-wifi-slash"></i>
    <span>ç¦»çº¿æ¨¡å¼</span>
  </div>

  <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
  <nav class="mobile-nav">
    <button class="mobile-nav-item" id="mobileToggleSidebar" data-action="sidebar">
      <i class="fas fa-sliders-h"></i>
      <span>æ§åˆ¶</span>
    </button>
    <button class="mobile-nav-item" id="mobileDashboard" data-action="dashboard">
      <i class="fas fa-chart-pie"></i>
      <span>ä»ªè¡¨ç›˜</span>
    </button>
    <button class="mobile-nav-item mobile-nav-center" id="mobileFitView" data-action="fit">
      <i class="fas fa-crosshairs"></i>
    </button>
    <button class="mobile-nav-item" id="mobileRanking" data-action="ranking">
      <i class="fas fa-trophy"></i>
      <span>æ’è¡Œ</span>
    </button>
    <button class="mobile-nav-item" id="mobileMore" data-action="more">
      <i class="fas fa-ellipsis-h"></i>
      <span>æ›´å¤š</span>
    </button>
  </nav>

  <!-- ç§»åŠ¨ç«¯æ›´å¤šèœå• -->
  <div id="mobileMoreMenu" class="mobile-more-menu hidden">
    <div class="mobile-more-backdrop"></div>
    <div class="mobile-more-content">
      <div class="mobile-more-header">
        <span>æ›´å¤šåŠŸèƒ½</span>
        <button class="close-btn" id="closeMobileMore">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="mobile-more-grid">
        <button class="mobile-more-item" data-action="comments">
          <i class="fas fa-comments"></i>
          <span>è¯„è®ºåŒº</span>
        </button>
        <button class="mobile-more-item" data-action="share">
          <i class="fas fa-share-alt"></i>
          <span>åˆ†äº«</span>
        </button>
        <button class="mobile-more-item" data-action="zoomIn">
          <i class="fas fa-search-plus"></i>
          <span>æ”¾å¤§</span>
        </button>
        <button class="mobile-more-item" data-action="zoomOut">
          <i class="fas fa-search-minus"></i>
          <span>ç¼©å°</span>
        </button>
        <button class="mobile-more-item" data-action="reset">
          <i class="fas fa-undo"></i>
          <span>é‡ç½®</span>
        </button>
        <button class="mobile-more-item" data-action="theme">
          <i class="fas fa-moon"></i>
          <span>ä¸»é¢˜</span>
        </button>
      </div>
    </div>
  </div>

  <!-- è„šæœ¬ -->
  <script src="data.js"></script>
  <script src="main.js"></script>
  <script src="share.js"></script>
  
  <!-- PWA Service Worker æ³¨å†Œ -->
  <script>
    // Service Worker æ³¨å†Œ
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const registration = await navigator.serviceWorker.register('/sw.js', {
            scope: '/'
          });
          
          console.log('[PWA] Service Worker registered:', registration.scope);
          
          // æ£€æŸ¥æ›´æ–°
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                // æ–°ç‰ˆæœ¬å¯ç”¨ï¼Œæ˜¾ç¤ºæ›´æ–°æç¤º
                showUpdatePrompt(registration);
              }
            });
          });
          
        } catch (error) {
          console.error('[PWA] Service Worker registration failed:', error);
        }
      });
      
      // ç›‘å¬æ§åˆ¶å™¨å˜åŒ–ï¼ˆæ›´æ–°ååˆ·æ–°é¡µé¢ï¼‰
      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });
    }
    
    // PWA å®‰è£…æç¤º
    let deferredPrompt;
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      // æ£€æŸ¥æ˜¯å¦å·²ç»å®‰è£…æˆ–ç”¨æˆ·å·²ç»æ‹’ç»
      const dismissed = localStorage.getItem('pwaInstallDismissed');
      const dismissedTime = dismissed ? parseInt(dismissed) : 0;
      const daysSinceDismissed = (Date.now() - dismissedTime) / (1000 * 60 * 60 * 24);
      
      // å¦‚æœè¶…è¿‡7å¤©ï¼Œå†æ¬¡æ˜¾ç¤º
      if (!dismissed || daysSinceDismissed > 7) {
        setTimeout(() => {
          document.getElementById('pwaInstallPrompt')?.classList.remove('hidden');
        }, 3000);
      }
    });
    
    // å®‰è£…æŒ‰é’®ç‚¹å‡»
    document.getElementById('pwaInstallBtn')?.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      console.log('[PWA] Install prompt outcome:', outcome);
      deferredPrompt = null;
      
      document.getElementById('pwaInstallPrompt')?.classList.add('hidden');
    });
    
    // ç¨åæŒ‰é’®ç‚¹å‡»
    document.getElementById('pwaInstallDismiss')?.addEventListener('click', () => {
      localStorage.setItem('pwaInstallDismissed', Date.now().toString());
      document.getElementById('pwaInstallPrompt')?.classList.add('hidden');
    });
    
    // æ˜¾ç¤ºæ›´æ–°æç¤º
    function showUpdatePrompt(registration) {
      const updatePrompt = document.getElementById('pwaUpdatePrompt');
      updatePrompt?.classList.remove('hidden');
      
      document.getElementById('pwaUpdateBtn')?.addEventListener('click', () => {
        registration.waiting?.postMessage({ type: 'SKIP_WAITING' });
        updatePrompt?.classList.add('hidden');
      });
      
      document.getElementById('pwaUpdateDismiss')?.addEventListener('click', () => {
        updatePrompt?.classList.add('hidden');
      });
    }
    
    // æ£€æµ‹å·²å®‰è£…çŠ¶æ€
    window.addEventListener('appinstalled', () => {
      console.log('[PWA] App installed');
      deferredPrompt = null;
      document.getElementById('pwaInstallPrompt')?.classList.add('hidden');
    });
    
    // ç¦»çº¿/åœ¨çº¿çŠ¶æ€ç›‘æµ‹
    function updateOnlineStatus() {
      const offlineIndicator = document.getElementById('offlineIndicator');
      if (!navigator.onLine) {
        offlineIndicator?.classList.remove('hidden');
      } else {
        offlineIndicator?.classList.add('hidden');
      }
    }
    
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    updateOnlineStatus();
  </script>
</body>
</html>
